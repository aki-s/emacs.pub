<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
 <head>
  <title>Examples -- DNS Updates</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <meta name="generator" content="PhD" />

  <link rel="start" href="index.html" title="PEAR Manual" />
  <link rel="up" href="package.networking.net-dns.html" title="Net_DNS" />
  <link rel="prev" href="package.networking.net-dns.net-dns-rr-intro.html" title="Class Summary Net_DNS_RR" />
  <link rel="next" href="package.networking.net-dnsbl.html" title="Net_DNSBL" />
 </head>
 <body>
<div class="navheader">
 <table style="width: 100%;">
  <tr><th colspan="3" style="text-align: center">Examples -- DNS Updates</th></tr>
  <tr>
   <td style="width: 40%; text-align: left;"><a href="package.networking.net-dns.net-dns-rr-intro.html" title="Class Summary Net_DNS_RR">Prev</a></td>
   <td style="width: 20%;"></td>
   <td style="width: 40%; text-align: right;"><a href="package.networking.net-dnsbl.html" title="Net_DNSBL">Next</a></td>
  </tr>
 </table>
 <hr/>
</div>
<div id="body">
<div class="refentry" id="package.networking.net-dns.net-dns-updates-example">
   
    <h1 class="refname">Examples -- <strong class="classname">DNS Updates</strong></h1>
    <div class="refnamediv">Examples --  <strong class="classname">DNS Updates</strong> &ndash; RFC 2136 DNS Updates</div>

   
   <div class="refsection"><div class="info"><h1>RFC 2136 DNS Updates</h1>
</div>
    
     <p class="para">
      By constructing a specially formatted DNS packet and sending it to a
      nameserver, a dynamic DNS update can be performed very easily.  RFC 2136
      defines some variations of a DNS packet that are used by Net_DNS to
      request an update.  The nameserver must first be configured to accept
      DNS updates, a key must be established between the client and server,
      and most importantly, the PHP mhash extension must be included for
      processing the MD5 digest of the key.
     </p>
     <p class="para">
      The format of the DNS packet is very specific and requires in-depth
      knowledge of how DNS updates work.  <strong class="classname">Net_DNS</strong>
      currently does not support any abstraction of these specially formatted
      packets.  Packets must currently be crafted and sent manually.  The full
      formatting of update packets can be found in RFC 2136.
     </p>
     <p class="para">
      For a complete listing of all of the fields that are available for DNS
      updates, please review RFC2136 (http://www.ietf.org/rfc/rfc2136.txt).
      The following examples show the simplest forms of a DNS update.
     </p>
     <div class="example"><div class="info"><p><strong>Sending a dynamic DNS update packet to a nameserver</strong></p></div>
      
       <div class="phpcode">
        <code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">require_once&nbsp;</span><span style="color: #DD0000">'Net/DNS.php'</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$resolver&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Net_DNS_Resolver</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;We&nbsp;should&nbsp;only&nbsp;send&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;master&nbsp;server<br />//&nbsp;accepting&nbsp;DNS&nbsp;updates&nbsp;for&nbsp;the&nbsp;zone.<br /></span><span style="color: #0000BB">$resolver</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nameservers&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">'192.168.0.254'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;We&nbsp;must&nbsp;manually&nbsp;construct&nbsp;the&nbsp;DNS&nbsp;packet&nbsp;for&nbsp;a&nbsp;DNS&nbsp;update<br />//&nbsp;First&nbsp;we&nbsp;must&nbsp;instantiate&nbsp;the&nbsp;packet&nbsp;object<br /></span><span style="color: #0000BB">$packet&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Net_DNS_Packet</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;Create&nbsp;the&nbsp;header&nbsp;for&nbsp;the&nbsp;update&nbsp;packet.&nbsp;&nbsp;Most&nbsp;of&nbsp;the&nbsp;defaults&nbsp;are<br />//&nbsp;acceptable,&nbsp;but&nbsp;we&nbsp;must&nbsp;set&nbsp;the&nbsp;header&nbsp;OPCODE&nbsp;to&nbsp;"UPDATE"<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Net_DNS_Header</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">id&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$resolver</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nextid</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">qr&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">opcode&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"UPDATE"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;As&nbsp;specified&nbsp;in&nbsp;RFC2136,&nbsp;the&nbsp;question&nbsp;section&nbsp;becomes&nbsp;the&nbsp;"ZONE"&nbsp;section.<br />//&nbsp;This&nbsp;specifies&nbsp;the&nbsp;zone&nbsp;for&nbsp;which&nbsp;we&nbsp;are&nbsp;requesting&nbsp;a&nbsp;change.&nbsp;&nbsp;This<br />//&nbsp;reflects&nbsp;the&nbsp;zone&nbsp;configuration&nbsp;as&nbsp;specified&nbsp;in&nbsp;the&nbsp;nameserver<br />//&nbsp;configuration.<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">question</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #0000BB">Net_DNS_Question</span><span style="color: #007700">(</span><span style="color: #DD0000">'example.com'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"SOA"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"IN"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;The&nbsp;"ANSWER"&nbsp;section&nbsp;of&nbsp;the&nbsp;packet&nbsp;becomes&nbsp;the&nbsp;"PREREQUISITE"&nbsp;section&nbsp;of<br />//&nbsp;the&nbsp;packet.&nbsp;Section&nbsp;2.4&nbsp;of&nbsp;RFC2136&nbsp;defines&nbsp;the&nbsp;possible&nbsp;values&nbsp;for&nbsp;this<br />//&nbsp;section.&nbsp;&nbsp;As&nbsp;show&nbsp;below,&nbsp;without&nbsp;any&nbsp;prerequisites&nbsp;the&nbsp;nameserver&nbsp;will<br />//&nbsp;attempt&nbsp;to&nbsp;perform&nbsp;the&nbsp;update&nbsp;unconditionally.<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">answer&nbsp;</span><span style="color: #007700">=&nbsp;array();<br /><br /></span><span style="color: #FF8000">//&nbsp;The&nbsp;AUTHORITY&nbsp;section&nbsp;becomes&nbsp;the&nbsp;"UPDATE"&nbsp;section&nbsp;of&nbsp;the&nbsp;DNS&nbsp;packet.&nbsp;&nbsp;The<br />//&nbsp;UPDATE&nbsp;section&nbsp;is&nbsp;a&nbsp;collection&nbsp;of&nbsp;resource&nbsp;record&nbsp;updates&nbsp;that&nbsp;should&nbsp;be<br />//&nbsp;modified&nbsp;in&nbsp;one&nbsp;form&nbsp;or&nbsp;another.&nbsp;&nbsp;RRs&nbsp;can&nbsp;be&nbsp;deleted&nbsp;or&nbsp;added&nbsp;based&nbsp;on&nbsp;the<br />//&nbsp;values&nbsp;passed&nbsp;in&nbsp;the&nbsp;RR&nbsp;object.&nbsp;&nbsp;These&nbsp;values&nbsp;are&nbsp;specified&nbsp;in&nbsp;RFC2136&nbsp;but<br />//&nbsp;are&nbsp;summarized&nbsp;here:<br />//<br />//&nbsp;Adding&nbsp;an&nbsp;RR<br />//&nbsp;A&nbsp;complete&nbsp;RR&nbsp;object&nbsp;with&nbsp;a&nbsp;non-zero&nbsp;TTL&nbsp;is&nbsp;considered&nbsp;an&nbsp;addition.<br />//<br />//&nbsp;Deleting&nbsp;an&nbsp;RR<br />//&nbsp;A&nbsp;complete&nbsp;RR&nbsp;object&nbsp;with&nbsp;a&nbsp;zero&nbsp;TTL&nbsp;is&nbsp;considered&nbsp;an&nbsp;deletion.&nbsp;An&nbsp;RR&nbsp;that<br />//&nbsp;matches&nbsp;(exactly)&nbsp;with&nbsp;all&nbsp;values&nbsp;except&nbsp;for&nbsp;the&nbsp;TTL&nbsp;will&nbsp;be&nbsp;removed.<br />//<br />//&nbsp;Deleting&nbsp;an&nbsp;RRset<br />//&nbsp;A&nbsp;complete&nbsp;RR&nbsp;object&nbsp;with&nbsp;a&nbsp;zero&nbsp;TTL&nbsp;and&nbsp;a&nbsp;type&nbsp;of&nbsp;ANY&nbsp;is&nbsp;considered&nbsp;a<br />//&nbsp;deletion&nbsp;of&nbsp;all&nbsp;RRs&nbsp;with&nbsp;the&nbsp;specified&nbsp;name&nbsp;and&nbsp;type.&nbsp;An&nbsp;RR&nbsp;that&nbsp;matches<br />//&nbsp;(exactly)&nbsp;with&nbsp;all&nbsp;values&nbsp;except&nbsp;for&nbsp;the&nbsp;TTL&nbsp;and&nbsp;the&nbsp;TYPE&nbsp;will&nbsp;be&nbsp;removed.<br />//<br />//&nbsp;Deleting&nbsp;all&nbsp;RRsets&nbsp;for&nbsp;a&nbsp;name&nbsp;<br />//&nbsp;A&nbsp;complete&nbsp;RR&nbsp;object&nbsp;with&nbsp;a&nbsp;zero&nbsp;TTL,&nbsp;a&nbsp;type&nbsp;of&nbsp;ANY,&nbsp;and&nbsp;a&nbsp;class&nbsp;of&nbsp;ANY&nbsp;is<br />//&nbsp;considered&nbsp;a&nbsp;deletion&nbsp;of&nbsp;all&nbsp;RRs&nbsp;with&nbsp;the&nbsp;specified&nbsp;name.&nbsp;Any&nbsp;RR&nbsp;that<br />//&nbsp;matches&nbsp;the&nbsp;name&nbsp;section&nbsp;of&nbsp;the&nbsp;query&nbsp;will&nbsp;be&nbsp;removed.<br />//<br />//&nbsp;The&nbsp;following&nbsp;specification&nbsp;will&nbsp;delete&nbsp;the&nbsp;RR&nbsp;that&nbsp;has&nbsp;a&nbsp;name&nbsp;of<br />//&nbsp;"example.com",&nbsp;class&nbsp;of&nbsp;"IN",&nbsp;type&nbsp;of&nbsp;"A",&nbsp;and&nbsp;an&nbsp;address&nbsp;of<br />//&nbsp;"192.0.34.166".<br /></span><span style="color: #0000BB">$rrDelete&nbsp;</span><span style="color: #007700">=&amp;&nbsp;</span><span style="color: #0000BB">Net_DNS_RR</span><span style="color: #007700">::</span><span style="color: #0000BB">factory</span><span style="color: #007700">(</span><span style="color: #DD0000">"example.com.&nbsp;0&nbsp;IN&nbsp;A&nbsp;192.0.34.166"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//<br />//&nbsp;The&nbsp;following&nbsp;specification&nbsp;will&nbsp;add&nbsp;an&nbsp;RR&nbsp;that&nbsp;has&nbsp;a&nbsp;name&nbsp;of&nbsp;example.com,<br />//&nbsp;a&nbsp;TTL&nbsp;of&nbsp;1&nbsp;hour,&nbsp;a&nbsp;class&nbsp;of&nbsp;"IN",&nbsp;type&nbsp;of&nbsp;"A",&nbsp;and&nbsp;an&nbsp;address&nbsp;of<br />//&nbsp;"192.0.34.155").&nbsp;&nbsp;Note&nbsp;that&nbsp;the&nbsp;only&nbsp;difference&nbsp;between&nbsp;this&nbsp;RR&nbsp;and&nbsp;the<br />//&nbsp;previous&nbsp;RR&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;TTL.<br /></span><span style="color: #0000BB">$rrAdd&nbsp;</span><span style="color: #007700">=&amp;&nbsp;</span><span style="color: #0000BB">Net_DNS_RR</span><span style="color: #007700">::</span><span style="color: #0000BB">factory</span><span style="color: #007700">(</span><span style="color: #DD0000">"example.com.&nbsp;3600&nbsp;IN&nbsp;A&nbsp;192.0.34.166"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//<br />//&nbsp;The&nbsp;RR&nbsp;modifications&nbsp;are&nbsp;added&nbsp;to&nbsp;the&nbsp;authority&nbsp;(UPDATE)&nbsp;section&nbsp;of&nbsp;the&nbsp;DNS<br />//&nbsp;packet.<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">authority</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]&nbsp;=&nbsp;</span><span style="color: #0000BB">$rrDelete</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">authority</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]&nbsp;=&nbsp;</span><span style="color: #0000BB">$rrAdd</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">//<br />//&nbsp;The&nbsp;signature&nbsp;must&nbsp;be&nbsp;present&nbsp;in&nbsp;any&nbsp;packet&nbsp;sent&nbsp;to&nbsp;a&nbsp;nameserver&nbsp;that<br />//&nbsp;requires&nbsp;authentication.&nbsp;&nbsp;The&nbsp;TSIG&nbsp;RR&nbsp;is&nbsp;added&nbsp;to&nbsp;the&nbsp;additional&nbsp;section&nbsp;of<br />//&nbsp;the&nbsp;DNS&nbsp;packet.<br /></span><span style="color: #0000BB">$tsig&nbsp;</span><span style="color: #007700">=&amp;&nbsp;</span><span style="color: #0000BB">Net_DNS_RR</span><span style="color: #007700">::</span><span style="color: #0000BB">factory</span><span style="color: #007700">(</span><span style="color: #DD0000">"keyname.as.specified.in.server.&nbsp;TSIG&nbsp;ThisIsMyKey"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">additional&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #0000BB">$tsig</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//&nbsp;Net_DNS&nbsp;does&nbsp;not&nbsp;automatically&nbsp;calculate&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;stored&nbsp;in<br />//&nbsp;each&nbsp;section.&nbsp;&nbsp;This&nbsp;calculation&nbsp;must&nbsp;be&nbsp;done&nbsp;manually.<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">qdcount&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">question</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ancount&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">answer</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nscount&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">authority</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">arcount&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">additional</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//<br />//&nbsp;After&nbsp;creating&nbsp;your&nbsp;packet,&nbsp;you&nbsp;must&nbsp;send&nbsp;it&nbsp;to&nbsp;the&nbsp;name&nbsp;server&nbsp;for<br />//&nbsp;processing.&nbsp;&nbsp;DNS&nbsp;updates&nbsp;must&nbsp;use&nbsp;the&nbsp;send_tcp()&nbsp;method:&nbsp;<br /></span><span style="color: #0000BB">$response&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$resolver</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">send_tcp</span><span style="color: #007700">(</span><span style="color: #0000BB">$packet</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$packet</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">data</span><span style="color: #007700">());<br /></span><span style="color: #FF8000">//<br />//&nbsp;The&nbsp;response&nbsp;from&nbsp;the&nbsp;server&nbsp;will&nbsp;vary.&nbsp;&nbsp;If&nbsp;the&nbsp;update&nbsp;was&nbsp;successfuly,&nbsp;the<br />//&nbsp;server&nbsp;will&nbsp;have&nbsp;a&nbsp;response&nbsp;code&nbsp;of&nbsp;"NOERROR".&nbsp;&nbsp;Any&nbsp;other&nbsp;error&nbsp;types&nbsp;will<br />//&nbsp;be&nbsp;reported&nbsp;in&nbsp;the&nbsp;response&nbsp;packet's&nbsp;header&nbsp;"rcode"&nbsp;variable.<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$response</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">rcode&nbsp;</span><span style="color: #007700">!=&nbsp;</span><span style="color: #DD0000">"NOERROR"</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;return(</span><span style="color: #0000BB">$response</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">header</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">rcode</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code>
       </div>
     </div>
   </div>
  </div>
</div>
<div class="navfooter">
 <hr />
 <table style="width: 100%;">
  <tr>
   <td style="width: 40%; text-align: left;"><a accesskey="p" href="package.networking.net-dns.net-dns-rr-intro.html">Prev</a></td>
   <td style="width: 20%; text-align: center;"><a accesskey="h" href="package.networking.net-dns.html">Net_DNS</a></td>
   <td style="width: 40%; text-align: right;"><a accesskey="n" href="package.networking.net-dnsbl.html">Next</a></td>
  </tr>
  <tr>
   <td style="text-align: left; vertical-align: top;">Class Summary Net_DNS_RR</td>
   <td style="text-align: center;"><a accesskey="h" href="index.html">PEAR Manual</a></td>
   <td style="text-align: right; vertical-align: top;">Net_DNSBL</td>
  </tr>
 </table>
</div>
</body></html>
